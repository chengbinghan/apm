<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="apm.web.dao.apmmysql.ReportFormDao">


    <select id="getErrorPer" parameterType="hashMap" resultType="java.lang.Double">

        SELECT
        (
        (SELECT count(1) FROM span s1  WHERE s1.errCode = 0 AND s1.rpc=s.rpc  AND s1.applicationId =s.applicationId AND s1.startTime &gt; #{startTime} AND s1.startTime &lt; #{endTime} )
        /
        (SELECT count(1) FROM span s2  WHERE s2.applicationId = s.applicationId  AND s2.rpc = s.rpc AND s2.startTime &gt; #{startTime} AND s2.startTime &lt; #{endTime} )
        ) as errPer

        FROM span s WHERE  s.applicationId = #{appId} AND s.rpc=#{rpc} AND s.startTime &gt; #{startTime}  AND s.startTime &lt; #{endTime} GROUP BY s.rpc;

    </select>


    <select id="getReportFormByRpcAndTime" parameterType="hashMap" resultMap="TransactionReportFormMap">

        SELECT
        count(1) AS  invokeCount,
        max(t1.elapsed) AS  maxResponseTime,
        min(t1.elapsed) AS  minResponseTime,
        avg(t1.elapsed) AS avgResponseTime,
        (sum(t1.elapsed) / (SELECT sum(t2.elapsed) FROM transaction t2 WHERE t2.startTime &gt; #{startTime} AND t2.application_id = #{appId} AND  t2.startTime &lt; #{endTime})) as transactionPer
        FROM
        transaction t1

        WHERE t1.rpc = #{rpc}  AND t1.application_id = #{appId}  AND t1.startTime &gt; #{startTime} AND  t1.startTime &lt; #{endTime} ORDER BY transactionPer DESC ;

    </select>


    <select id="getTransactionTime" parameterType="hashMap" resultMap="TransactionReportFormMap">


        SELECT
  bb.rpc as transactionUrl,
  convert(bb.transaction_percent, decimal(10,2)) as transactionPer,
  max_transactionTime as maxResponseTime,
  min_transactionTime as minResponseTime,
  avg_transactionTime as avgResponseTime,
  transaction_count as invokeCount
FROM

  (SELECT
     sum(t.elapsed) / (SELECT sum(elapsed)

                       FROM transaction t2

                       WHERE
                         t2.application_id = #{appId} AND t2.startTime > (SELECT UNIX_TIMESTAMP()*1000 - #{time} )) as transaction_percent,
     t.rpc,
     t.application_id,
     max(t.elapsed) as max_transactionTime,
     min(t.elapsed) as min_transactionTime,
     avg(t.elapsed) as avg_transactionTime,
     count(t.elapsed) as transaction_count
   FROM transaction t
   WHERE t.application_id = #{appId} AND t.startTime > (SELECT UNIX_TIMESTAMP()*1000 - #{time} )
   GROUP BY rpc) as bb

ORDER BY bb.transaction_percent DESC LIMIT 0,30;

    </select>

    <select id="getApdex" parameterType="hashMap" resultType="java.lang.Double">
        SELECT
        (
        (((SELECT count(1) FROM transaction t2  WHERE t2.application_id = t.application_id AND t2.rpc = t.rpc AND t2.startTime &gt; #{startTime} AND t2.startTime &lt; #{endTime}  AND t2.elapsed &lt; (0.3 * 1000)))
        +
        (SELECT count(1) FROM transaction t3 WHERE t3.application_id = t.application_id AND t3.rpc = t.rpc AND t3.startTime &gt; #{startTime}  AND t3.startTime &lt; #{endTime}  AND  t3.elapsed  &lt;  (0.7 * 1000) AND t3.elapsed &gt; (0.3*1000) ) * 0.5 )/
        (SELECT count(1) FROM transaction t4 WHERE  t4.application_id = t.application_id AND t4.rpc = t.rpc AND t4.startTime &gt; #{startTime} AND t4.startTime &lt; #{endTime} )
        ) as apdex

        FROM transaction t WHERE t.application_id = #{appId} AND t.rpc = #{rpc} AND t.startTime &gt; #{startTime}  AND t.startTime &lt; #{endTime} GROUP BY t.application_id;
    </select>

    <select id="getEachDatabaseReportFormInfoVO" parameterType="hashMap" resultMap="DataBaseReportInfoVOMap">

        SELECT
  sql1.sqlInfo        AS sqlInfo,
  se1.sqlId           AS sqlId,
  sp1.rpc             AS rpc,
  api1.apiInfo        AS apiInfo,
  sum(se1.endElapsed) AS totalTime,
  avg(se1.endElapsed) AS avgTime,
  min(se1.endElapsed) AS minTime,
  max(se1.endElapsed) AS maxTime,
  count(1)            AS invokeCount
FROM span_event se1, span sp1, sql_meta_data_ver2 sql1, api_meta_data api1
WHERE se1.spanId = sp1.spanId AND sp1.applicationId = #{appId} AND se1.startElapsed &lt;  #{endTime} AND se1.startElapsed &gt; #{startTime}  AND se1.sqlId = #{sqlMetaDataId} AND sql1.sqlMetaDataId = se1.sqlId AND se1.apiId = api1.apiId AND
      sp1.startTime > (0)

    </select>


    <select id="getSqlListByAppId" parameterType="java.lang.String" resultMap="sqlMap">
         SELECT
  sql1.sqlMetaDataId AS sqlMetaDataId,
  sql1.sqlInfo AS sqlInfo
FROM sql_meta_data_ver2 sql1, span sp1, span_event se1
WHERE sql1.sqlMetaDataId = se1.sqlId AND se1.spanId = sp1.spanId AND sp1.applicationId = #{appId}
GROUP BY sql1.sqlMetaDataId;



    </select>

    <resultMap id="sqlMap" type="apm.web.beans.module.Sql">

        <result property="sqlMetaDataId" column="sqlMetaDataId"/>
        <result property="sqlInfo" column="sqlInfo"/>
        <!--其它的属性暂时不用-->
    </resultMap>

    <resultMap id="DataBaseReportInfoVOMap" type="apm.web.beans.vo.DatabaseReportFormInfoVO">

        <result property="avgResponseTime" column="avgTime"/>
        <result property="maxResponseTime" column="maxTime"/>
        <result property="minResponseTime" column="minTime"/>
        <result property="totalTime" column="totalTime"/>
        <result property="invokeCount" column="invokeCount"/>
        <result property="apiInfo" column="apiInfo"/>
    </resultMap>

    <resultMap id="TransactionReportFormMap" type="apm.web.beans.vo.TransactionReportFormInfoVO">
        <result property="avgResponseTime" column="avgResponseTime"/>
        <result property="maxResponseTime" column="maxResponseTime"/>
        <result property="minResponseTime" column="minResponseTime"/>
        <result property="errorPer" column="errorPer"/>
        <result property="throughput" column="throughput"/>
        <result property="apdex" column="apdex"/>
        <result property="transactionUrl" column="transactionUrl"/>
        <result property="transactionPer" column="transactionPer"/>
        <result property="transactionPer" column="transactionPer"/>
        <result property="invokeCount" column="invokeCount"/>
    </resultMap>


</mapper>
