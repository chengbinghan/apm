<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="apm.web.dao.apmmysql.MonitorProDao">


    <select id="getAllMonitorPro" resultMap="monitorProMap">
SELECT
  m1.id AS id,
  m1.appId as appId,
  m1.userId as userId,
  m1.strategyId as strategyId,
  ms1.id as monitorPro_id,
  ms1.monitors as monitoPro_monitors,
  ms1.name as monitorPro_name,
  ms1.type as monitorPro_type

FROM
  monitorpro m1,
  monitorstrategy ms1
WHERE m1.strategyId = ms1.id;

    </select>


    <select id="monitorResponseTime" resultType="Double">

        SELECT sum(elapsed)/count(1) as avgResponseTime
        from transaction t1 WHERE t1.startTime &gt; (#{currentTime} - #{timeSection}) AND t1.startTime &lt; #{currentTime} AND t1.application_id =#{appId};

    </select>

    <select id="monitorRpm" parameterType="hashMap" resultType="java.lang.Long">

        SELECT count(1)
        from transaction t1 WHERE  t1.application_id = #{appId} AND t1.endtime &lt; #{currentTime} AND t1.startTime &gt; (#{currentTime} - #{timeSection})



    </select>

    <select id="getMonitorErrorPercentByCondition" parameterType="hashMap" resultType="java.lang.Double">

        SELECT

        err_table.errTotalCount / correct_table.correctTotalCount AS errPer
        FROM

        (SELECT
        count(1) AS errTotalCount
        FROM span_event se2, span sp1 WHERE se2.spanId = sp1.spanId
        AND se2.exceptionId != 0 AND sp1.applicationId = #{appId}
        AND sp1.startTime &gt; (#{currentTime} - #{timeSection})
        AND sp1.startTime &lt; #{currentTime}
        ) AS err_table,
        (SELECT

        count(1) AS correctTotalCount

        FROM span sp1, span_event se1
        WHERE
        sp1.applicationId = #{appId}
        AND
        se1.spanId = sp1.spanId
        AND sp1.startTime > (#{currentTime} - #{timeSection})
        AND sp1.startTime &lt; #{currentTime}) AS correct_table

        ORDER BY errPer DESC;

    </select>

    <resultMap id="monitorProMap" type="apm.web.beans.module.MonitorPro">
        <result property="id" column="id"/>

        <result property="userIds" column="userId"/>

        <result property="app.id" column="appId"/>
        <result property="monitorStrategy.id" column="monitorPro_id"/>
        <result property="monitorStrategy.name" column="monitorPro_name"/>
        <result property="monitorStrategy.type" column="monitorPro_type"/>
        <result property="monitorStrategy.monitors" column="monitoPro_monitors"/>
    </resultMap>


</mapper>
